version: '3.8'

# Production Docker Compose với SSL và Security Hardening
# Sử dụng: docker-compose -f docker-compose.prod.yml up -d

services:
  # MySQL Database với SSL
  mysql:
    image: mysql:8.0
    container_name: cafe-shop-mysql-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: cafeshop
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-ssl:/etc/mysql/ssl:ro
    ports:
      - "127.0.0.1:3306:3306"  # Chỉ bind localhost
    networks:
      - cafe-shop-network
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/lib/mysql-files
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --ssl-ca=/etc/mysql/ssl/ca.pem
      - --ssl-cert=/etc/mysql/ssl/server-cert.pem
      - --ssl-key=/etc/mysql/ssl/server-key.pem
      - --require-secure-transport=ON
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "--ssl"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend Spring Boot
  backend:
    build:
      context: ./baochung_st22a
      dockerfile: Dockerfile
    container_name: cafe-shop-backend-prod
    restart: always
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/cafeshop?allowPublicKeyRetrieval=true&useSSL=true&requireSSL=true&verifyServerCertificate=true&useSSL=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_PROFILES_ACTIVE: production
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_KEY-STORE: /app/ssl/keystore.p12
      SERVER_SSL_KEY-STORE-PASSWORD: ${SSL_KEYSTORE_PASSWORD}
    volumes:
      - ./backend-ssl:/app/ssl:ro
    expose:
      - "8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - cafe-shop-network
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost:8080/api/home/health", "--insecure"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend React + Nginx với SSL
  frontend:
    build:
      context: ./coffee-shop-master
      dockerfile: Dockerfile
    container_name: cafe-shop-frontend-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl/fullchain.pem:/etc/nginx/ssl/cert.pem:ro
      - ./ssl/privkey.pem:/etc/nginx/ssl/key.pem:ro
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    networks:
      - cafe-shop-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "https://localhost:443/", "--no-check-certificate"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  cafe-shop-network:
    driver: bridge
    internal: false  # Cho phép kết nối ra ngoài nhưng kiểm soát chặt chẽ
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  mysql_data:
    driver: local

